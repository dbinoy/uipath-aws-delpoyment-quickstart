{
    "AWSTemplateFormatVersion": "2010-09-09",
    "Description": "This template creates a Multi-AZ, multi-subnet VPC infrastructure with UIPath Orchestrator deployed in private Subnets, with an ALB behind a Route53 in public subnets",
    "Metadata": {
        "AWS::CloudFormation::Interface": {
            "ParameterGroups": [
                {
                    "Label": {
                        "default": "Availability Zone Configuration"
                    },
                    "Parameters": [
                        "AvailabilityZones",
                        "NumberOfAZs"
                    ]
                },
                {
                    "Label": {
                        "default": "Network Configuration"
                    },
                    "Parameters": [
                        "VPCCIDR",
                        "PublicSubnet1CIDR",
                        "PublicSubnet2CIDR",
                        "PublicSubnet3CIDR",
                        "PublicSubnetTag1",
                        "PublicSubnetTag2",
                        "PublicSubnetTag3",
                        "PrivateSubnet1CIDR",
                        "PrivateSubnet2CIDR",
                        "PrivateSubnet3CIDR",
                        "PrivateSubnetTag1",
                        "PrivateSubnetTag2",
                        "PrivateSubnetTag3"
                    ]
                },
                {
                    "Label": {
                        "default": "Orchestrator Instance Configuration"
                    },
                    "Parameters": [
                        "KeyPairName",
                        "InstanceType"
                    ]
                },
                {
                    "Label": {
                        "default": "Customer Contact"
                    },
                    "Parameters": [
                        "EmailAddress"
                    ]
                },
                {
                    "Label": {
                        "default": "Quickstart Bucket configuration"
                    },
                    "Parameters": [
                        "SourceCodeBucket",
                        "TemplateLocation"
                    ]
                }                                                                                    
            ],
            "ParameterLabels": {
                "AvailabilityZones": {
                    "default": "Availability Zones"
                },
                "NumberOfAZs": {
                    "default": "Number of Availability Zones"
                },
                "VPCCIDR": {
                    "default": "VPC CIDR"
                },                
                "PublicSubnet1CIDR": {
                    "default": "Public subnet 1 CIDR"
                },
                "PublicSubnet2CIDR": {
                    "default": "Public subnet 2 CIDR"
                },     
                "PublicSubnet3CIDR": {
                    "default": "Public subnet 3 CIDR"
                },        
                "PublicSubnetTag1": {
                    "default": "Tag for Public subnet 1"
                },  
                "PublicSubnetTag2": {
                    "default": "Tag for Public subnet 2"
                },      
                "PublicSubnetTag3": {
                    "default": "Tag for Public subnet 3"
                },                                                                
                "PrivateSubnet1CIDR": {
                    "default": "Private subnet 1 CIDR"
                },  
                "PrivateSubnet2CIDR": {
                    "default": "Private subnet 2 CIDR"
                },  
                "PrivateSubnet3CIDR": {
                    "default": "Private subnet 3 CIDR"
                },       
                "PrivateSubnetTag1": {
                    "default": "Tag for Private subnet 1"
                },      
                "PrivateSubnetTag2": {
                    "default": "Tag for Private subnet 2"
                },         
                "PrivateSubnetTag3": {
                    "default": "Tag for Private subnet 3"
                },
                "KeyPairName": {
                    "default": "Orchestrator Instance Key pair name"
                },
                "InstanceType": {
                    "default": "Orchestrator Instance type"
                },
                "EmailAddress": {
                    "default": "Email Address for notification"
                },
                "SourceCodeBucket": {
                    "default": "S3 Bucket name hosting the Quickstart templates"
                },
                "TemplateLocation": {
                    "default": "Folder in S3 Bucket containing the Quickstart templates"
                }                
                                                                                                                                          
            }
        }
    },
    "Parameters": {
        "EmailAddress": {
            "AllowedPattern": "([a-zA-Z0-9_\\-\\.]+)@((\\[[0-9]{1,3}\\.[0-9]{1,3}\\.[0-9]{1,3}\\.)|(([a-zA-Z0-9\\-]+\\.)+))([a-zA-Z]{2,4}|[0-9]{1,3})(\\]?)",
            "ConstraintDescription": "Must be a valid email id.",
            "Description": "Email Address for notification",
            "Type": "String"
        },        
        "AvailabilityZones": {
            "Description": "List of Availability Zones to use for the subnets in the VPC. Maximum of 3 Availability Zones are used for this deployment, and the logical order of your selections is preserved.",
            "Type": "List<AWS::EC2::AvailabilityZone::Name>"
        },
        "NumberOfAZs": {
            "AllowedValues": [
                "1",
                "2",
                "3"
            ],
            "Default": "1",
            "Description": "Number of Availability Zones to use in the VPC (upto 3). This must match your selections in the list of Availability Zones parameter.",
            "Type": "String"
        },        
        "KeyPairName": {
            "Description": "Orchestrator Instance Key pair name",
            "Type": "String",
            "Default": ""
        },   
        "InstanceType": {
            "AllowedValues": [
              "t2.micro",
              "t2.small",
              "t2.medium",
              "t2.large",
              "m4.large",
              "m4.xlarge",
              "m4.2xlarge",
              "m4.4xlarge",
              "m4.10xlarge",
              "c4.large",
              "c4.xlarge",
              "c4.2xlarge",
              "c4.4xlarge",
              "c4.8xlarge",
              "r4.large",
              "r4.xlarge",
              "r4.2xlarge",
              "r4.4xlarge",
              "r4.8xlarge"
            ],
            "ConstraintDescription": "Must be a valid EC2 instance type.",
            "Default": "t2.medium",
            "Description": "EC2 instance type",
            "Type": "String"
        },             
        "VPCCIDR": {
            "AllowedPattern": "^([0-9]{1,3}\\.){2}([0]{1}.)[0]{1}(\\/[16]{2})$",
            "ConstraintDescription": "CIDR block parameter must be in the form x.x.0.0/16",
            "Default": "10.0.0.0/16",
            "Description": "CIDR block for the VPC",
            "Type": "String"
        },    
        "PrivateSubnetTag1": {
            "AllowedPattern": "^([a-zA-Z0-9+\\-._:/@]+=[a-zA-Z0-9+\\-.,_:/@ *\\\\\"'\\[\\]\\{\\}]*)?$",
            "ConstraintDescription": "tags must be in format \"Key=Value\" keys can only contain [a-zA-Z0-9+\\-._:/@], values can contain [a-zA-Z0-9+\\-._:/@ *\\\\\"'\\[\\]\\{\\}]",
            "Default": "Network=Private",
            "Description": "Tag to add to private subnet 1 in format Key=Value (Optional)",
            "Type": "String"
        },
        "PrivateSubnetTag2": {
            "AllowedPattern": "^([a-zA-Z0-9+\\-._:/@]+=[a-zA-Z0-9+\\-.,_:/@ *\\\\\"'\\[\\]\\{\\}]*)?$",
            "ConstraintDescription": "tags must be in format \"Key=Value\" keys can only contain [a-zA-Z0-9+\\-._:/@], values can contain [a-zA-Z0-9+\\-._:/@ *\\\\\"'\\[\\]\\{\\}]",
            "Default": "",
            "Description": "Tag to add to private subnet 2 in format Key=Value (Optional)",
            "Type": "String"
        },
        "PrivateSubnetTag3": {
            "AllowedPattern": "^([a-zA-Z0-9+\\-._:/@]+=[a-zA-Z0-9+\\-.,_:/@ *\\\\\"'\\[\\]\\{\\}]*)?$",
            "ConstraintDescription": "tags must be in format \"Key=Value\" keys can only contain [a-zA-Z0-9+\\-._:/@], values can contain [a-zA-Z0-9+\\-._:/@ *\\\\\"'\\[\\]\\{\\}]",
            "Default": "",
            "Description": "Tag to add to private subnet 3 in format Key=Value (Optional)",
            "Type": "String"
        },            
        "PublicSubnetTag1": {
            "AllowedPattern": "^([a-zA-Z0-9+\\-._:/@]+=[a-zA-Z0-9+\\-.,_:/@ *\\\\\"'\\[\\]\\{\\}]*)?$",
            "ConstraintDescription": "tags must be in format \"Key=Value\" keys can only contain [a-zA-Z0-9+\\-._:/@], values can contain [a-zA-Z0-9+\\-._:/@ *\\\\\"'\\[\\]\\{\\}]",
            "Default": "Network=Public",
            "Description": "Tag to add to public subnet 1 in format Key=Value (Optional)",
            "Type": "String"
        },
        "PublicSubnetTag2": {
            "AllowedPattern": "^([a-zA-Z0-9+\\-._:/@]+=[a-zA-Z0-9+\\-.,_:/@ *\\\\\"'\\[\\]\\{\\}]*)?$",
            "ConstraintDescription": "tags must be in format \"Key=Value\" keys can only contain [a-zA-Z0-9+\\-._:/@], values can contain [a-zA-Z0-9+\\-._:/@ *\\\\\"'\\[\\]\\{\\}]",
            "Default": "",
            "Description": "Tag to add to public subnet 2 in format Key=Value (Optional)",
            "Type": "String"
        },
        "PublicSubnetTag3": {
            "AllowedPattern": "^([a-zA-Z0-9+\\-._:/@]+=[a-zA-Z0-9+\\-.,_:/@ *\\\\\"'\\[\\]\\{\\}]*)?$",
            "ConstraintDescription": "tags must be in format \"Key=Value\" keys can only contain [a-zA-Z0-9+\\-._:/@], values can contain [a-zA-Z0-9+\\-._:/@ *\\\\\"'\\[\\]\\{\\}]",
            "Default": "",
            "Description": "Tag to add to public subnet 3 in format Key=Value (Optional)",
            "Type": "String"
        },                  
        "SourceCodeBucket": {
            "AllowedPattern": "^[0-9a-zA-Z]+([0-9a-zA-Z-]*[0-9a-zA-Z])*$",
            "ConstraintDescription": "Quick Start bucket name can include numbers, lowercase letters, uppercase letters, and hyphens (-). It cannot start or end with a hyphen (-).",
            "Default": "uipath-aws-delpoyment-quickstart",
            "Description": "S3 bucket name for the Quick Start assets. Quick Start bucket name can include numbers, lowercase letters, uppercase letters, and hyphens (-). It cannot start or end with a hyphen (-).",
            "Type": "String"
        },
        "TemplateLocation": {
            "AllowedPattern": "^[0-9a-zA-Z-]*$",
            "ConstraintDescription": "Quick Start key prefix can include numbers, lowercase letters, uppercase letters, and hyphens (-).",
            "Default": "templates",
            "Description": "S3 key prefix for the Quick Start assets. Quick Start key prefix can include numbers, lowercase letters, uppercase letters, and hyphens (-).",
            "Type": "String"
        }
    },
    "Resources": {
        "NetworkStack": {
            "Type" : "AWS::CloudFormation::Stack",
            "Properties" : {
                "TemplateURL" : {"Fn::Join": ["/", ["https:", "",
                                    {"Fn::Join": [".", [ {"Ref": "SourceCodeBucket"}, "s3", {"Ref": "AWS::Region"}, "amazonaws", "com" ]]},
                                    {"Ref": "TemplateLocation"}, "network.template.json" ]]},
                "Parameters" : {
                    "AvailabilityZones": {"Fn::Join": ["-", {"Ref": "AvailabilityZones"} ]},
                    "NumberOfAZs": {"Ref": "NumberOfAZs"},
                    "VPCCIDR": {"Ref": "VPCCIDR"},
                    "PublicSubnetTag1": {	"Ref": "PublicSubnetTag1"},
                    "PublicSubnetTag2": {"Ref": "PublicSubnetTag2"},
                    "PublicSubnetTag3": {"Ref": "PublicSubnetTag3"},
                    "PrivateSubnetTag1": {	"Ref": "PrivateSubnetTag1"},
                    "PrivateSubnetTag2": {"Ref": "PrivateSubnetTag2"},
                    "PrivateSubnetTag3": {"Ref": "PrivateSubnetTag3"}                                         
                }
            }
        },
        "SecurityStack": {
            "Type" : "AWS::CloudFormation::Stack",
            "Properties" : {
                "TemplateURL" : {"Fn::Join": ["/", ["https:", "",
                                    {"Fn::Join": [".", [ {"Ref": "SourceCodeBucket"}, "s3", {"Ref": "AWS::Region"}, "amazonaws", "com" ]]},
                                    {"Ref": "TemplateLocation"}, "security.template.json" ]]},
                "Parameters" : {
                    "VPCID": { "Fn::GetAtt" : ["NetworkStack", "Outputs.VPCID"] },
                    "VPCCIDR": {"Ref": "VPCCIDR"}                                        
                }
            }
        }                
    },
    "Outputs": {
    }
}