{
    "AWSTemplateFormatVersion": "2010-09-09",
    "Description": "This template creates an Route53 Hosted zone and adds related record sets",
    "Parameters": {
		"VPCID": {
			"Type": "AWS::EC2::VPC::Id"
		},        
        "GatewaySecurityGroup": {
            "Description": "Security Group behind which Storage Gateway VMs would be placed",
            "Type": "String"
        },      
        "SubnetIDs": {
            "Description": "Comma separated Subnet IDs where Gateway VMs need to be launched",
            "Type": "String"
        },          
        "Domain": {
            "Description": "Fully Qualified Domain Name for hosting",
            "Type": "String",
            "AllowedPattern": "^(([a-zA-Z0-9]|[a-zA-Z0-9][a-zA-Z0-9\\-]*[a-zA-Z0-9])\\.){2,}([A-Za-z0-9]|[A-Za-z0-9][A-Za-z0-9\\-]*[A-Za-z0-9]){2,}$",
            "Default": "www.uipath-orchestrator-quickstart.com",
            "ConstraintDescription" : "Should be a fully qualified domain name"
        },
        "CustomLambdaRoleArn": {
            "Description": "ARN for IAM Role to be assumed by Lambda functinos creating Storage Gateway custom resources",
            "Type": "String"
        }                    
    },
    "Conditions": {
        "1AZCondition": {
            "Fn::Not": [
                {
                    "Fn::Equals": [
                        { "Fn::Select" : [ "0", { "Fn::Split": [",", {"Ref": "SubnetIDs"}]}] },
                        "-"
                    ]
                }
            ]            
        },
        "2AZCondition": {
            "Fn::Not": [
                {
                    "Fn::Equals": [
                        { "Fn::Select" : [ "1", { "Fn::Split": [",", {"Ref": "SubnetIDs"}]}] },
                        "-"
                    ]
                }
            ]            
        },
        "3AZCondition": {
            "Fn::Not": [
                {
                    "Fn::Equals": [
                        { "Fn::Select" : [ "2", { "Fn::Split": [",", {"Ref": "SubnetIDs"}]}] },
                        "-"
                    ]
                }
            ]            
        }                
    },     
	"Resources": {
        "ApplicationLoadBalancer" : {
            "Type" : "AWS::ElasticLoadBalancingV2::LoadBalancer",
            "Properties" : {
                "Name" : "UiPathStack-ALB",
                "Type" : "application",
                "Scheme" : "internet-facing",            
                "SecurityGroups" : [ {"Ref": "GatewaySecurityGroup"} ],
                "Subnets" : [
                    { "Fn::Select" : [ "0", { "Fn::Split": [",", {"Ref": "SubnetIDs"}]}] },
                    {
                        "Fn::If": [
                            "2AZCondition",
                            { "Fn::Select" : [ "1", { "Fn::Split": [",", {"Ref": "SubnetIDs"}]}] },
                            { "Ref": "AWS::NoValue" }
                        ]
                    },
                    {
                        "Fn::If": [
                            "3AZCondition",
                            { "Fn::Select" : [ "2", { "Fn::Split": [",", {"Ref": "SubnetIDs"}]}] },
                            { "Ref": "AWS::NoValue" }
                        ]
                    }
                ]                        
            }
        },
        "TargetGroup": {
            "Type" : "AWS::ElasticLoadBalancingV2::TargetGroup",
            "Properties" : {
                "Name" : "UiPathStack-ALB-target",
                "Port" : 443,
                "Protocol" : "HTTPS", 
                "VpcId" :  {"Ref": "VPCID"},      
                "TargetGroupAttributes" : [ 
                    { "Key" : "stickiness.enabled", "Value" : "true" },
                    { "Key" : "stickiness.type", "Value" : "lb_cookie" }
                ],  
                "TargetType" : "ip",
                "HealthCheckPath" : "/api/status",
                "HealthCheckPort" : "80",
                "HealthCheckProtocol" : "HTTP"
            }
        },
        "HostedZone": {
            "Type" : "AWS::Route53::HostedZone",
            "Properties" : {
                "Name" : {"Ref": "Domain"},
                "HostedZoneConfig" : {
                    "Comment": { "Fn::Join" : [" ", ["Hosted Zone for", {"Ref": "Domain"}]]}
                }
            }
        },
        "RequestAWSCertificateFunction": {
            "Type": "AWS::Lambda::Function",
            "Properties": {
                "Description" : "Requests issuance and validation of a new ACM certificate",
                "Handler": "index.handler",
                "Role": {"Ref" : "CustomLambdaRoleArn"},
                "Code": {
                    "ZipFile" : { "Fn::Join" : ["\n", [
                        "import json",
                        "import boto3",
                        "import cfnresponse",
                        "acm = boto3.client('acm')",
                        "gatewayClient = boto3.client('storagegateway')",
                        "def create(properties, physical_id):",
                        "    domain = properties['DomainName']",
                        "    certResponse = acm.request_certificate(",
                        "        DomainName=domain,",
                        "        ValidationMethod='DNS'",
                        "    )",
                        "    certificateArn = certResponse['CertificateArn']",
                        "    print(f'certificateArn = {certificateArn}')",                        
                        "    certificateDetails = acm.describe_certificate(",
                        "        CertificateArn=certificateArn",
                        "    )",
                        "    acmDomainName = certificateDetails['Certificate']['DomainName']",
                        "    acmRecordName = certificateDetails['Certificate']['DomainValidationOptions'][0]['ResourceRecord']['Name']",
                        "    acmRecordValue = certificateDetails['Certificate']['DomainValidationOptions'][0]['ResourceRecord']['Value']",
                        "    acmRecordType = certificateDetails['Certificate']['DomainValidationOptions'][0]['ResourceRecord']['Type']",
                        "    print(f'acmDomainName = {acmDomainName}')",
                        "    print(f'acmRecordName = {acmRecordName}')",
                        "    print(f'acmRecordValue = {acmRecordValue}')",
                        "    print(f'acmRecordType = {acmRecordType}')",
                        "    returnAttribute = {}",
                        "    returnAttribute['DomainName'] = acmDomainName",
                        "    returnAttribute['RecordName'] = acmRecordName",
                        "    returnAttribute['RecordValue'] = acmRecordValue",
                        "    returnAttribute['RecordType'] = acmRecordType",                        
                        "    returnAttribute['Action'] = 'CREATE'",
                        "    return cfnresponse.SUCCESS, certificateArn, returnAttribute",                       
                        "def delete(properties, physical_id):",
                        "    certificateArn = physical_id",
                        "    returnAttribute['Action'] = DELETE",
                        "    return cfnresponse.SUCCESS, certificateArn, {}", 
                        "def handler(event, context):",
                        "    status = cfnresponse.FAILED",
                        "    new_physical_id = None",
                        "    try:",
                        "        properties = event.get('ResourceProperties')",
                        "        physical_id = event.get('PhysicalResourceId')",
                        "        status, new_physical_id, returnAttribute = {",
                        "            'Create': create,",
                        "            'Update': create,",
                        "            'Delete': delete",
                        "        }.get(event['RequestType'], lambda x, y: (cfnresponse.FAILED, None))(properties, physical_id)",
                        "    except Exception as e:",
                        "        print('Exception: ' + e)",
                        "        status = cfnresponse.FAILED",
                        "    finally:",
                        "        cfnresponse.send(event, context, status, returnAttribute, new_physical_id)"
                    ]]}
                },
                "Runtime": "python3.6",
                "Timeout": 30,
                "TracingConfig": {
                    "Mode": "Active"
                }
            }
        },    
		"AWSCertificate": {
            "Type": "Custom::AWSCertificate",
            "Properties": {
                    "ServiceToken": { "Fn::GetAtt" : ["RequestAWSCertificateFunction", "Arn"] },
                    "DomainName" : {"Ref": "Domain"}
            }
        },       
        "CertificateValidationRecordSet": {
            "Type" : "AWS::Route53::RecordSet",
            "Properties" : {
                "HostedZoneId" : {"Ref" : "HostedZone"},
                "Name" : {"Fn::GetAtt" : ["AWSCertificate", "RecordName"]},
                "Type" : {"Fn::GetAtt" : ["AWSCertificate", "RecordType"]},                
                "ResourceRecords" : [ {"Fn::GetAtt" : ["AWSCertificate", "RecordValue"]} ]
            }
        },             
        "HttpListener": {
            "Type" : "AWS::ElasticLoadBalancingV2::Listener",
            "Properties" : {
                "LoadBalancerArn" : {"Ref": "ApplicationLoadBalancer"},
                "Port" : 80,
                "Protocol" : "HTTP",                
                "DefaultActions" : [ 
                    {
                        "Type" : "redirect",
                        "RedirectConfig" : {
                            "Port" : "443",
                            "Protocol" : "HTTPS",
                            "StatusCode" : "HTTP_301"
                        }                    
                    } 
                ]
            }
        },
        "HttpsListener": {
            "Type" : "AWS::ElasticLoadBalancingV2::Listener",
            "Properties" : {
                "LoadBalancerArn" : {"Ref": "ApplicationLoadBalancer"},
                "Port" : 443,
                "Protocol" : "HTTPS",                
                "DefaultActions" : [ 
                    {
                        "Type" : "forward",
                        "TargetGroupArn" : {"Ref": "TargetGroup"}                  
                    } 
                ],
                "SslPolicy": "ELBSecurityPolicy-2016-08",
                "Certificates" : [ 
                    {
                        "CertificateArn" : {"Ref": "AWSCertificate"}
                    } 
                ]
            }
        },        
        "RecordSet": {
            "Type" : "AWS::Route53::RecordSet",
            "Properties" : {
                "HostedZoneId" : {"Ref" : "HostedZone"},
                "Name" : {"Ref": "Domain"},
                "Type" : "A",
                
                "AliasTarget" : {
                    "EvaluateTargetHealth" : false,
                    "DNSName" : {"Fn::GetAtt" : ["ApplicationLoadBalancer", "DNSName"]},                    
                    "HostedZoneId" : {"Fn::GetAtt" : ["ApplicationLoadBalancer", "CanonicalHostedZoneID"]}
                }
            }
        }
    },
	"Outputs": {
        "ApplicationLoadBalancer": {
            "Value": {"Fn::GetAtt" : ["ApplicationLoadBalancer", "LoadBalancerFullName"]},
            "Description": "Application Load Balancer Name"
        },     
        "TargetGroupName": {
            "Value": {"Ref" : "TargetGroup"},
            "Description": "Target Group Name"
        },         
        "TargetGroupARN": {
            "Value": {"Fn::GetAtt" : ["TargetGroup", "TargetGroupFullName"]},
            "Description": "Target Group Name"
        },                 
        "HostedZoneID": {
            "Value": {"Ref" : "HostedZone"},
            "Description": "Route53 Hosted Zone ID"
        },        
        "AWSCertificate": {
            "Value":  {"Ref" : "AWSCertificate"},
            "Description": "AWS Certificate Manager Certificate Resource"
        },
        "CertificateValidationRecordSet": {
            "Value":  {"Ref" : "CertificateValidationRecordSet"},
            "Description": "Route53 CNAME Record"
        },         
        "HttpListener": {
            "Value":  {"Ref" : "HttpListener"},
            "Description": "HTTP Listener ARN"
        },
        "HttpsListener": {
            "Value":  {"Ref" : "HttpsListener"},
            "Description": "HTTPS Listener ARN"
        },
        "RecordSet": {
            "Value":  {"Ref" : "RecordSet"},
            "Description": "Route53 A Record"
        }                                                      					
	}     
}    